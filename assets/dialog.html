<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login Dialog</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>

<body class="bg-gray-50 flex items-center justify-center min-h-screen">
    <div class="bg-white shadow-lg rounded-2xl p-8 w-full max-w-md">
        <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Login</h2>

        <!-- Error/Success message -->
        <div id="messageBox" class="hidden mb-4 p-3 rounded-md text-sm"></div>

        <form id="loginForm" class="flex flex-col gap-4">
            <!-- License Key -->
            <div class="flex flex-col">
                <label class="mb-1 text-sm font-medium text-gray-700">License Key</label>
                <input type="text" id="licenseKey"
                    class="px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 border-gray-300 focus:ring-green-500"
                    placeholder="Enter License Key" />
                <span id="licenseKeyError" class="hidden text-xs text-red-500 mt-1"></span>
            </div>

            <!-- Company ID -->
            <div class="flex flex-col">
                <label class="mb-1 text-sm font-medium text-gray-700">Company ID</label>
                <input type="text" id="companyID"
                    class="px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 border-gray-300 focus:ring-green-500"
                    placeholder="Enter Company ID" />
                <span id="companyIDError" class="hidden text-xs text-red-500 mt-1"></span>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitButton"
                class="w-full py-2 rounded-full font-semibold text-sm transition-all bg-[#107C41] text-white shadow-md hover:bg-[#0e6e39]">
                Submit
            </button>
        </form>
    </div>

    <script>
        // Login API
        const authenticateUser = async (licenseKey, companyID, callback) => {
            try {
                const myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                const raw = JSON.stringify({
                    license_code: licenseKey,
                    company_id: companyID,
                });

                const requestOptions = {
                    method: "POST",
                    headers: myHeaders,
                    body: raw,
                };

                const response = await fetch(
                    "https://zpdwekrejwwncdikouve.supabase.co/functions/v1/auth-endpoint",
                    requestOptions
                );
                const result = await response.json();

                if (result.success !== true) {
                    callback(result.error || "Authentication failed", null);
                } else {
                    callback(null, result);
                }
            } catch (error) {
                callback(error.message || "Network error", null);
            }
        };

        Office.onReady(() => {
            const form = document.getElementById("loginForm");
            const licenseKeyInput = document.getElementById("licenseKey");
            const companyIDInput = document.getElementById("companyID");
            const licenseKeyError = document.getElementById("licenseKeyError");
            const companyIDError = document.getElementById("companyIDError");
            const submitButton = document.getElementById("submitButton");
            const messageBox = document.getElementById("messageBox");

            form.addEventListener("submit", (e) => {
                e.preventDefault();

                let valid = true;
                licenseKeyError.classList.add("hidden");
                companyIDError.classList.add("hidden");
                messageBox.classList.add("hidden");

                if (!licenseKeyInput.value.trim()) {
                    licenseKeyError.textContent = "License Key is required";
                    licenseKeyError.classList.remove("hidden");
                    valid = false;
                }

                if (!companyIDInput.value.trim()) {
                    companyIDError.textContent = "Company ID is required";
                    companyIDError.classList.remove("hidden");
                    valid = false;
                }

                if (!valid) return;

                submitButton.disabled = true;
                submitButton.classList.add("bg-gray-300", "cursor-not-allowed");
                submitButton.classList.remove("bg-[#107C41]", "hover:bg-[#0e6e39]");

                // Call login API
                authenticateUser(
                    licenseKeyInput.value,
                    companyIDInput.value,
                    (error, data) => {
                        if (error) {
                            messageBox.textContent = error;
                            messageBox.className =
                                "mb-4 p-3 rounded-md text-sm bg-red-100 text-red-700";
                            messageBox.classList.remove("hidden");
                            submitButton.disabled = false;
                            submitButton.classList.remove("bg-gray-300", "cursor-not-allowed");
                            submitButton.classList.add("bg-[#107C41]", "hover:bg-[#0e6e39]");
                        } else if (data) {
                            messageBox.textContent = "Authentication successful!";
                            messageBox.className =
                                "mb-4 p-3 rounded-md text-sm bg-green-100 text-green-700";
                            messageBox.classList.remove("hidden");
                            submitButton.disabled = false;
                            console.log(data);

                            // Add licenseKey, companyID into session_info
                            data.data.session_info.license_key = licenseKeyInput.value;
                            data.data.session_info.company_id = companyIDInput.value;

                            // Send to Office host
                            if (Office.context.ui && Office.context.ui.messageParent) {
                                Office.context.ui.messageParent(JSON.stringify(data));
                            };
                        }
                    }
                );
            });
        });
    </script>
</body>

</html>